/*! angular-audio-player 22-07-2013 */
angular.module("angular-audio-player",[]).directive("audioPlayer",["$rootScope","$log","$interpolate","$timeout",function(a,b,c,d){return{scope:{exposedPlayer:"=playerControl",playlist:"=playlist"},link:function(a,e){if("AUDIO"!==e[0].tagName)return b.error("audioPlayer directive works only when attached to an <audio> type tag");var f=e[0],g=[],h=e.find("source"),i=a.playlist||[];angular.forEach(h,function(a){g.push({src:a.src,type:a.type,media:a.media})}),g.length&&i.unshift(g),a.exposedPlayer={playing:!1,playingTrack:0,tracks:i.length,play:function(){!this.playingTrack&&f.readyState&&this.playingTrack++,f.play()},playPause:function(){this.playing?this.pause():this.play()},pause:function(){f.pause()},next:function(){var a=this;a.playingTrack&&a.playingTrack<a.tracks&&(a.pause(),d(function(){a._clearAudioList(),a._addAudioList(i[a.playingTrack]),f.load(),a.playingTrack++}))},prev:function(){var a=this;a.playingTrack&&a.playingTrack-1&&(a.pause(),d(function(){a._clearAudioList(),a._addAudioList(i[a.playingTrack-2]),f.load(),a.playingTrack--}))},_addAudioList:function(a){if(angular.isArray(a))angular.forEach(a,function(a){var b=angular.element(c('<source src="{{ src }}" type="{{ type }}" media="{{ media }}">')(a));e.append(b)});else if(angular.isObject(a)){var b=angular.element(c('<source src="{{ src }}" type="{{ type }}" media="{{ media }}">')(a));e.append(b)}},_clearAudioList:function(){e.contents().remove()}},f.addEventListener("playing",function(){a.$apply(function(){a.exposedPlayer.playing=!0})}),f.addEventListener("pause",function(){a.$apply(function(){a.exposedPlayer.playing=!1})}),f.addEventListener("ended",function(){b.warn("ended!")}),a.$watch("playlist",function(c,e){b.warn("playlist changed");var g,h=a.exposedPlayer,i=null;if(h.playingTrack){g=e[h.playingTrack-1];for(var j=0;j<c.length;j++)if(angular.equals(c[j],g)){i=j;break}i?(h.playingTrack=i+1,h.tracks=c.length):(f.pause(),c.length&&d(function(){h._clearAudioList(),h._addAudioList(c[0]),f.load(),h.tracks=c.length}))}else c.length&&(h._clearAudioList(),h._addAudioList(c[0]),f.load(),h.tracks=c.length)},!0),a.$on("$destroy",function(){})}}}]);